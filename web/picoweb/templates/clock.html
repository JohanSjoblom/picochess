<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Picochess Webserver</title>
    <link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.ico">
    <link rel="stylesheet" href="/static/css/bootstrap-5.5.2.min.css" />
    <link rel="stylesheet" href="/static/css/chessground/chessground.css" />
    <link rel="stylesheet" href="/static/css/chessground/theme.css" />
    <link rel="stylesheet" href="/static/css/chessground/theme_natural_wood.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/datatables.min.css" />
    <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
    {% try %}
    {% if theme=='dark' %}
    <link rel="stylesheet" href="/static/css/mdb.dark.min.css" />
    {% end %}
    {% if theme=='light' %}
    <link rel="stylesheet" href="/static/css/mdb.min.css" />
    {% end %}
    {% except %}
    <link rel="stylesheet" href="/static/css/mdb.dark.min.css" />
    {% end %}
    <link rel="stylesheet" href="/static/css/select.dataTables.css" />
    <link rel="stylesheet" href="/static/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="/static/css/custom.css" />
    <link rel="stylesheet" href="/static/css/engine-analysis.css" />
    <link rel="stylesheet" href="/static/css/responsive-board.css" />
    <style>
        /* Enable vertical scrolling for mobile portrait mode */
        @media (max-width: 768px) {
            .scroll-portrait {
                height: 100vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Barra de evaluaci√≥n horizontal */
        .evaluation-bar-horizontal {
            margin-bottom: 10px;
        }

        .evaluation-container-horizontal {
            position: relative;
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #f8f9fa 0%, #f8f9fa 50%, #343a40 50%, #343a40 100%);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .evaluation-fill-horizontal {
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            background-color: rgba(248, 249, 250, 0.9);
            transition: all 0.3s ease;
        }

        .evaluation-fill-horizontal.negative {
            background-color: rgba(52, 58, 64, 0.9);
        }

        .evaluation-center-line-horizontal {
            position: absolute;
            left: 50%;
            top: 0;
            width: 1px;
            height: 100%;
            background-color: #6c757d;
            transform: translateX(-50%);
        }

        .evaluation-value-horizontal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 10px;
            color: #000;
            background: transparent;
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }
    </style>


    <script type="text/javascript" src="/static/js/jquery-3.6.1.min.js"></script>
    <script>
        // Parche global para prevenir errores de Bootstrap
        (function() {
            // Interceptar errores globales
            window.addEventListener('error', function(e) {
                if (e.message && (e.message.includes('split') || e.message.includes('null'))) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Parche para split
            const originalSplit = String.prototype.split;
            String.prototype.split = function() {
                if (this == null || this == undefined) return [];
                return originalSplit.apply(this, arguments);
            };
            
            // Parche para getAttribute
            const originalGetAttribute = Element.prototype.getAttribute;
            Element.prototype.getAttribute = function(name) {
                const value = originalGetAttribute.call(this, name);
                return value === null ? '' : value;
            };
        })();
    </script>
    <script type="text/javascript" src="/static/js/datatables.min.js"></script>
    <script type="text/javascript" src="/static/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-5.5.2.min.js"></script>
    <script type="text/javascript" src="/static/js/chess960.min.js"></script>
    <script type="text/javascript" src="/static/js/chessground.min.js"></script>
</head>

<body>
    {% try %}
    {% if theme=='dark' or theme=='light' %}
    <script type="text/javascript" src="/static/js/mdb.min.js"></script>
    {% end %}
    {% except %}
    <script type="text/javascript" src="/static/js/mdb.min.js"></script>
    {% end %}
    <div class="scroll-portrait">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div id="board_panel" class="panel panel-primary">
                            <div class="card-body" style="position:relative;">
                                <div id="evaluationBar" class="evaluation-bar-horizontal" style="display: none;">
                                    <div class="evaluation-container-horizontal">
                                        <div class="evaluation-fill-horizontal" id="evaluationFill"></div>
                                        <div class="evaluation-center-line-horizontal"></div>
                                        <div class="evaluation-value-horizontal" id="evaluationValue">0.0</div>
                                    </div>
                                </div>
                                <section id="xboardsection" class="natural-wood merida svg-container">
                                    <div class="board-container">
                                        <div id="board" class="svg-content" style="margin-bottom: 10px;"></div>
                                    </div>
                                </section>
                                <div class="container-fluid" id="boardcontrol">
                                    <div class="row" id="boardButtons">
                                        <div class="text-center">
                                            <div class="btn-group btn-group-lg d-flex" role="group">
                                                <button type="button" id="flipOrientationBtn" class="btn btn-light">
                                                    <i class="fa fa-refresh"></i> <span
                                                        class="btn-text">Flip</span></button>
                                                <button type="button" id="DgtSyncBtn" class="btn btn-light">
                                                    <i class="fa fa-delicious"></i> <span
                                                        class="btn-text">Sync</span></button>
                                                <button type="button" id="startBtn" class="btn btn-light">
                                                    <i class='fa fa-fast-backward'></i></button>
                                                <button type="button" id="backBtn" class="btn btn-light">
                                                    <i class='fa fa-arrow-left'></i></button>
                                                <button type="button" id="fwdBtn" class="btn btn-light">
                                                    <i class='fa fa-arrow-right'></i></button>
                                                <button type="button" id="endBtn" class="btn btn-light">
                                                    <i class='fa fa-fast-forward'></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="pull-left">
                                                <div class="boardinfo">
                                                    <span id="sidetomove"></span>&nbsp;<span id="BoardStatus"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="boardControlButtons" class="col">
                                            <div class="d-flex justify-content-end flex-wrap gap-2">
                                                <!-- Download button -->
                                                <button type="button" id="downloadBtn" class="btn btn-info btn-sm">
                                                    <i class="fa fa-download"></i>
                                                    <span class="btn-text"> Get PGN</span>
                                                </button>

                                                <!-- Upload button (now consistent as a real button) -->
                                                <button type="button" id="uploadBtn" class="btn btn-info btn-sm">
                                                    <i class="fa fa-upload"></i>
                                                    <span class="btn-text"> Upload</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <div class="col">
                    <div class="container">
                        <div class="row">
                            <div class="card">
                                <div class="card-header"
                                    style="font-size: 2.5vh; display: flex; justify-content: space-between; align-items: center;">
                                    <span>PicoChess Version 4.1.6</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <form id="moveForm" autocomplete="off" style="margin: 0;">
                                            <input id="moveInput" type="text" inputmode="none" value="" style="
                                                position:absolute;
                                                left:0; top:0;
                                                opacity:0;
                                                caret-color:transparent;
                                                border:none;
                                                outline:none;
                                                width:1px; height:1px;" maxlength="5" autocomplete="off"
                                                autocorrect="off" autocapitalize="off" spellcheck="false"
                                                title="Move" data-bs-toggle="" />
                                        </form>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="pull-left">
                                        <div id="DGTClockText"></div>
                                    </div>
                                    <div class="pull-right">
                                        <div id="DGTClockStatus"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div id="clockbuttons" class="text-center">
                                <div class="btn-group btn-group-lg d-flex" role="group">
                                    <button type="button" id="ClockLeverBtn" class="btn btn-danger"
                                        data-placement="auto">
                                        <i id="leverUp" class='fa fa-long-arrow-up fa-lg'></i><i id="leverDown"
                                            class='fa fa-long-arrow-down fa-lg' style="display: none;"></i>
                                    </button>
                                    <button type="button" id="ClockBtn0" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-backward fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn1" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-minus fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn2" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-pause fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn3" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-plus fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn4" class="btn btn-warning" data-placement="auto">
                                        <i class='fa fa-forward fa-lg'></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="card">
                                <div class="scroll_movelist" id="moveList">
                                    <div class="card-body">
                                        <div id="pgn"
                                            style="max-height:37%; overflow-y:auto; overflow-x:hidden; min-height:20%; position:relative;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div id="data" class="card">
                                <div class="card-header">
                                    <ul class="nav nav-pills mb-0" id="pills-tab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="pills-home-tab" data-bs-toggle="pill"
                                                data-bs-target="#engine" type="button" role="tab">Engine
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="pills-profile-tab" data-bs-toggle="pill"
                                                data-bs-target="#book" type="button" role="tab">Book
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill"
                                                data-bs-target="#games" type="button" role="tab">Games
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="pills-scan-tab" data-bs-toggle="pill"
                                                data-bs-target="#scan" type="button" role="tab">Scan
                                            </button>
                                        </li>
                                    </ul>

                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="pills-tabContent">
                                        <div class="tab-pane fade" id="engine" role="tabpanel">
                                            <div class="scroll_engine">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <span id="engineMultiPVStatus" class="btn-group"></span>
                                                    </div>
                                                    <div class="col-8">
                                                        <div class="btn-group btn-group-xs pull-right" role="group">
                                                            <button id="analyzeBtn" class="btn btn-success"
                                                                data-placement="auto">
                                                                <i class='fa fa-cog'></i>
                                                                <span id="AnalyzeText">Analyze</span>
                                                            </button>
                                                        </div>
                                                        <div class="btn-group btn-group-xs pull-right" role="group">
                                                            <button id="analyzeMinus" class="btn btn-light"
                                                                data-placement="auto">
                                                                <span id="analyzeMinusText">
                                                                    <i class='fa fa-minus'></i>
                                                                </span>
                                                            </button>
                                                            <button id="analyzePlus" class="btn btn-light"
                                                                data-placement="auto">
                                                                <span id="analyzePlusText"><i
                                                                        class='fa fa-plus'></i></span>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div id="listener">
                                                        <embed name="nacl_module" id='stockfish_module' width="0"
                                                            height="0" src='/static/stockfish/stockfish.nmf'
                                                            type='application/x-pnacl' />
                                                    </div>
                                                    <div id="engineStatus"></div>
                                                </div>
                                                <div class="row">
                                                    <div id="pv_output" class="gameMoves list-group">
                                                        <div id="pv_1" class="pv-container">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade show active" id="book" role="tabpanel"
                                            style="padding-left: 10px;">
                                            <div class="scroll_obooklist">
                                                <table id="BookTable" class="table compact table-bordered row-border"
                                                    style="font-size: 1.6vw; text-align: center; width: 100%;">
                                                    <thead>
                                                        <tr>
                                                            <th data-priority="1">Move</th>
                                                            <th data-priority="2">Games</th>
                                                            <th>Results</th>
                                                        </tr>
                                                    </thead>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="games" role="tabpanel">
                                            <table id="GameTable"
                                                class="table table-hover compact table-bordered row-border"
                                                style="font-size: 1.3vw; width: 100%;">
                                                <thead>
                                                    <tr>
                                                        <th data-priority="1">White</th>
                                                        <th data-priority="2">Black</th>
                                                        <th data-priority="3">Result</th>
                                                        <th data-priority="4">Event</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>
                                        <div class="tab-pane fade" id="scan" role="tabpanel">
                                            <div class="scroll_obooklist">
                                                <div class="scan-controls" style="padding: 15px;">
                                                    <div class="row mb-3">
                                                        <div class="col-12 text-center">
                                                            <button type="button" id="scanBoardBtn" class="btn btn-danger btn-lg" style="width: 100%;">
                                                                <i class="fa fa-delicious"></i> <span class="d-none d-sm-inline">Sync Board</span><span class="d-inline d-sm-none">Sync</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="row mb-3 align-items-center">
                                                    <div class="col-4">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="sideToPlaySwitch">
                                                            </div>
                                                            <div id="pawnPreview" style="display: flex; align-items: center; gap: 3px;">
                                                                <div id="pawnPiece" style="width: 30px; height: 30px; background-color: white; border: 0.5px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: black;">‚ôô</div>
                                                                <div style="font-size: 20px; font-weight: bold;">‚Üë</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="d-flex align-items-center gap-2" style="justify-content: center;">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="boardSideSwitch">
                                                            </div>
                                                            <div id="boardPreview" style="display: flex; flex-direction: column; align-items: center;">
                                                                <div style="display: flex; flex-direction: column; width: 30px; height: 30px; border: 2px solid #333;">
                                                                    <div style="display: flex; width: 100%; height: 50%;">
                                                                        <div id="topLeftSquare" style="width: 50%; height: 100%; background-color: white; border: 1px solid #666;"></div>
                                                                        <div id="topRightSquare" style="width: 50%; height: 100%; background-color: black; border: 1px solid #666;"></div>
                                                                    </div>
                                                                    <div style="display: flex; width: 100%; height: 50%;">
                                                                        <div id="bottomLeftSquare" style="width: 50%; height: 100%; background-color: black; border: 1px solid #666;"></div>
                                                                        <div id="bottomRightSquare" style="width: 50%; height: 100%; background-color: white; border: 1px solid #666;"></div>
                                                                    </div>
                                                                </div>
                                                                <div id="sideIndicator" style="width: 20px; height: 6px; background-color: white; margin-top: 3px; border: 0.5px solid #333;"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="d-flex align-items-center gap-2" style="justify-content: flex-end;">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="uci960Switch">
                                                            </div>
                                                            <label class="form-check-label" for="uci960Switch" id="uci960Label" style="font-size: 14px; font-weight: bold;">
                                                                UCI960 No
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-6">
                                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="whiteCastleKingSwitch" checked>
                                                                <label class="form-check-label" for="whiteCastleKingSwitch">
                                                                    <span style="color: white; text-shadow: 1px 1px 0 black, -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black;">&#9632;</span> O-O
                                                                </label>
                                                            </div>
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="whiteCastleQueenSwitch" checked>
                                                                <label class="form-check-label" for="whiteCastleQueenSwitch">
                                                                    <span style="color: white; text-shadow: 1px 1px 0 black, -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black;">&#9632;</span> O-O-O
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="blackCastleKingSwitch" checked>
                                                                <label class="form-check-label" for="blackCastleKingSwitch">
                                                                    <span style="color: black; text-shadow: 1px 1px 0 white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;">&#9632;</span> O-O
                                                                </label>
                                                            </div>
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox" id="blackCastleQueenSwitch" checked>
                                                                <label class="form-check-label" for="blackCastleQueenSwitch">
                                                                    <span style="color: black; text-shadow: 1px 1px 0 white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;">&#9632;</span> O-O-O
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/static/js/app.js?v=2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Script del input de movimientos
            const moveInput = document.getElementById('moveInput');
            if (moveInput) {
                moveInput.focus();
                moveInput.addEventListener('keydown', async function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const move = (this.value || '').toString();
                        if (move && move.length > 0) {
                            await fetch('/channel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: 'action=command&command=' + encodeURIComponent(move)
                            });
                            this.value = "";
                        }
                    }
                });
                // Mantener el foco siempre en el input de jugada
                document.addEventListener('click', function (e) {
                    if (e.target !== moveInput && moveInput) {
                        setTimeout(() => moveInput.focus(), 10);
                    }
                });
            }
        });
    </script>


    <!-- JavaScript for consistent tab rendering and board display -->
    <script>
        // Force consistent board rendering regardless of active tab
        document.addEventListener('DOMContentLoaded', function () {
            // Get all tab buttons
            const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');

            // Add click event listeners to all tab buttons
            tabButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    // Get the board element
                    const board = document.getElementById('board');

                    // Force reflow of the board element
                    if (board) {
                        // Small delay to allow tab switching to complete
                        setTimeout(function () {
                            // These operations force a reflow/repaint
                            const display = board.style.display;
                            board.style.display = 'none';
                            void board.offsetHeight; // Trigger reflow
                            board.style.display = display;

                            // Additional resize event to reposition chessground
                            const evt = new Event('resize');
                            window.dispatchEvent(evt);
                        }, 50);
                    }
                });
            });

            // Ajustar el ancho de la barra de evaluaci√≥n al ancho del tablero
            function adjustEvaluationBarWidth() {
                var boardElement = document.getElementById('board');
                var evaluationContainer = document.querySelector('.evaluation-container-horizontal');
                if (boardElement && evaluationContainer) {
                    var boardWidth = boardElement.offsetWidth;
                    evaluationContainer.style.width = boardWidth + 'px';
                }
            }

            setTimeout(adjustEvaluationBarWidth, 500);
            window.addEventListener('resize', adjustEvaluationBarWidth);

            // Forzar redibujado del tablero
            setTimeout(function () {
                if (window.chessground1) {
                    chessground1.redrawAll();
                }
            }, 100);
        });
    </script>

    <!-- JavaScript para los controles del tab Scan -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Control del bando que juega
            const sideToPlaySwitch = document.getElementById('sideToPlaySwitch');
            const sideToPlayLabel = document.getElementById('sideToPlayLabel');
            
            sideToPlaySwitch.addEventListener('change', function() {
                const pawnPiece = document.getElementById('pawnPiece');
                if (this.checked) {
                    pawnPiece.style.backgroundColor = 'black';
                    pawnPiece.style.color = 'white';
                    pawnPiece.style.border = '0.5px solid white';
                    pawnPiece.innerHTML = '‚ôü';
                } else {
                    pawnPiece.style.backgroundColor = 'white';
                    pawnPiece.style.color = 'black';
                    pawnPiece.style.border = '0.5px solid #333';
                    pawnPiece.innerHTML = '‚ôô';
                }
            });

            // Control del lado del tablero
            const boardSideSwitch = document.getElementById('boardSideSwitch');
            
            boardSideSwitch.addEventListener('change', function() {
                const sideIndicator = document.getElementById('sideIndicator');
                if (this.checked) {
                    // Tablero desde perspectiva negras (negras abajo)
                    sideIndicator.style.backgroundColor = 'black';
                    sideIndicator.style.border = '0.5px solid white';
                } else {
                    // Tablero desde perspectiva blancas (blancas abajo)
                    sideIndicator.style.backgroundColor = 'white';
                    sideIndicator.style.border = '0.5px solid #333';
                }
            });

            // Control del UCI960
            const uci960Switch = document.getElementById('uci960Switch');
            const uci960Label = document.getElementById('uci960Label');
            
            uci960Switch.addEventListener('change', function() {
                if (this.checked) {
                    uci960Label.textContent = 'UCI960';
                } else {
                    uci960Label.textContent = 'UCI960 No';
                }
            });

            // Bot√≥n de escanear tablero
            scanBoardBtn.addEventListener('click', async function() {
                // Obtener valores de los controles
                const sideToPlay = sideToPlaySwitch.checked ? 'false' : 'true';
                const boardSide = boardSideSwitch.checked ? 'true' : 'false';
                const whiteCastleKing = document.getElementById('whiteCastleKingSwitch').checked;
                const whiteCastleQueen = document.getElementById('whiteCastleQueenSwitch').checked;
                const blackCastleKing = document.getElementById('blackCastleKingSwitch').checked;
                const blackCastleQueen = document.getElementById('blackCastleQueenSwitch').checked;
                const uci960 = uci960Switch.checked ? 'true' : 'false';
                
                try {
                    // Obtener FEN actual del tablero
                    const currentFen = window.chessground1 ? window.chessground1.getFen() : 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR';
                    
                    // Enviar solicitud de escaneo al servidor
                    const response = await fetch('/channel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            action: 'scan_board',
                            currentFen: currentFen,
                            sideToPlay: sideToPlay,
                            boardSide: boardSide,
                            whiteCastleKing: whiteCastleKing,
                            whiteCastleQueen: whiteCastleQueen,
                            blackCastleKing: blackCastleKing,
                            blackCastleQueen: blackCastleQueen,
                            uci960: uci960
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.fen) {
                            console.log('Escaneo completado. FEN:', result.fen);
                            // El FEN se actualiza autom√°ticamente via WebSocket
                        } else {
                            console.error('Error: Posici√≥n inv√°lida');
                        }
                    } else {
                        console.error('Error en el escaneo del tablero');
                    }
                } catch (error) {
                    console.error('Error de conexi√≥n:', error);
                }
            });
        });
    </script>
</body>

</html>