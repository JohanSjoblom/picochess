<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Picochess Webserver</title>
    <link rel="shortcut icon" type="image/x-icon" href="/static/img/favicon.ico">
    <link rel="stylesheet" href="/static/css/bootstrap-5.5.2.min.css" />
    <link rel="stylesheet" href="/static/css/chessground/chessground.css" />
    <link rel="stylesheet" href="/static/css/chessground/theme.css" />
    <link rel="stylesheet" href="/static/css/chessground/theme_natural_wood.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/datatables.min.css" />
    <link rel="stylesheet" href="/static/css/font-awesome.min.css" />
    {% try %}
    {% if theme=='dark' %}
    <link rel="stylesheet" href="/static/css/mdb.dark.min.css" />
    {% end %}
    {% if theme=='light' %}
    <link rel="stylesheet" href="/static/css/mdb.min.css" />
    {% end %}
    {% except %}
    <link rel="stylesheet" href="/static/css/mdb.dark.min.css" />
    {% end %}
    <link rel="stylesheet" href="/static/css/select.dataTables.css" />
    <link rel="stylesheet" href="/static/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="/static/css/base.css" />
    <link rel="stylesheet" href="/static/css/responsive/1024x600.css" />
    <link rel="stylesheet" href="/static/css/responsive/1280x800.css" />
    <link rel="stylesheet" href="/static/css/responsive/mobile.css" />
    <link rel="stylesheet" href="/static/css/responsive/desktop.css" />
    <style>
        /* Enable vertical scrolling for mobile portrait mode */
        @media (max-width: 768px) {
            .scroll-portrait {
                height: 98vh;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
            }

            html,
            body {
                overflow-x: hidden;
            }
        }

        /* Barra de evaluaciÃ³n horizontal */
        .evaluation-bar-horizontal {
            margin-bottom: 10px;
        }

        .evaluation-container-horizontal {
            position: relative;
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #f8f9fa 0%, #f8f9fa 50%, #343a40 50%, #343a40 100%);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .evaluation-fill-horizontal {
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            background-color: rgba(248, 249, 250, 0.9);
            transition: all 0.3s ease;
        }

        .evaluation-fill-horizontal.negative {
            background-color: rgba(52, 58, 64, 0.9);
        }

        .evaluation-center-line-horizontal {
            position: absolute;
            left: 50%;
            top: 0;
            width: 1px;
            height: 100%;
            background-color: #6c757d;
            transform: translateX(-50%);
        }

        .evaluation-value-horizontal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 20px;
            color: #000;
            background: transparent;
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
        }

        /* Book moves table: fixed layout so width is constant */
        #BookTable {
            table-layout: fixed;
            width: 100%;
        }

        /* Universal button styles for all tabs - 3D effect */
        .btn, .menu-button {
            position: relative;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            background: linear-gradient(145deg, #6bb6ff, #4a9eff);
            color: white;
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.25),
                0 2px 4px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .btn:hover, .menu-button:hover {
            transform: translateY(-1px);
            background: linear-gradient(145deg, #7bc5ff, #5aadff);
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.3),
                0 3px 6px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            color: white;
        }

        .btn:active, .menu-button:active {
            transform: translateY(1px);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.25),
                0 1px 2px rgba(0, 0, 0, 0.15),
                inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Special colors for specific button types */
        .btn-success {
            background: linear-gradient(145deg, #6bb6ff, #4a9eff) !important;
        }
        .btn-success:hover {
            background: linear-gradient(145deg, #7bc5ff, #5aadff) !important;
        }
        .btn-success.active,
        .btn-success:active {
            background: linear-gradient(145deg, #5cb85c, #449d44) !important;
        }

        .btn-danger {
            background: linear-gradient(145deg, #d9534f, #c9302c) !important;
        }
        .btn-danger:hover {
            background: linear-gradient(145deg, #e9635f, #d9403c) !important;
        }

        .btn-warning {
            background: linear-gradient(145deg, #f0ad4e, #ec971f) !important;
        }
        .btn-warning:hover {
            background: linear-gradient(145deg, #ffbd5e, #fca72f) !important;
        }

        .btn-info {
            background: linear-gradient(145deg, #5bc0de, #31b0d5) !important;
        }
        .btn-info:hover {
            background: linear-gradient(145deg, #6bd0ee, #41c0e5) !important;
        }

        .btn-light {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef) !important;
            color: #495057 !important;
            text-shadow: none !important;
        }
        .btn-light:hover {
            background: linear-gradient(145deg, #ffffff, #f8f9fa) !important;
            color: #495057 !important;
        }

        /* Universal active state - all buttons turn green when active */
        .btn.active,
        .btn:active,
        .menu-button.active {
            background: linear-gradient(145deg, #5cb85c, #449d44) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 
                0 4px 8px rgba(92, 184, 92, 0.4),
                0 2px 4px rgba(92, 184, 92, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
        }

        /* Menu button specific styles */
        .menu-button {
            width: 60%;
            aspect-ratio: 1.5;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            font-size: clamp(0.7rem, 2vw, 0.9rem);
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 8px;
            min-height: 60px;
        }

        .menu-button i {
            display: block;
            margin-bottom: 4px;
            font-size: 1.2em;
            opacity: 0.95;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.2));
        }

        .menu-button span {
            font-size: 0.8em;
            line-height: 1.1;
            text-align: center;
            word-wrap: break-word;
            max-width: 100%;
            font-weight: 600;
        }

        /* Active state for menu buttons */
        .menu-button.active {
            background: linear-gradient(145deg, #5cb85c, #449d44);
            transform: translateY(-1px);
            box-shadow: 
                0 4px 8px rgba(92, 184, 92, 0.4),
                0 2px 4px rgba(92, 184, 92, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Games table styling */
        #GameTable {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
        }

        #GameTable th,
        #GameTable td {
            padding: 8px 6px;
            text-align: left;
            vertical-align: middle;
            border: 1px solid rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 0;
            height: 40px;
            line-height: 1.2;
        }

        #GameTable th {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            color: #495057;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.8);
            border-bottom: 2px solid #dee2e6;
        }

        #GameTable tbody tr {
            transition: all 0.2s ease;
        }

        #GameTable tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        #GameTable tbody tr:hover {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Column width distribution */
        #GameTable th:nth-child(1),
        #GameTable td:nth-child(1) {
            width: 28%;
        }

        #GameTable th:nth-child(2),
        #GameTable td:nth-child(2) {
            width: 28%;
        }

        #GameTable th:nth-child(3),
        #GameTable td:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        #GameTable th:nth-child(4),
        #GameTable td:nth-child(4) {
            width: 29%;
        }

        /* Responsive adjustments for games table */
        @media (max-width: 768px) {
            #GameTable {
                font-size: 0.8rem;
            }
            
            #GameTable th,
            #GameTable td {
                padding: 6px 4px;
                height: 35px;
            }
            
            .menu-button {
                font-size: 0.75rem;
                min-height: 50px;
                padding: 6px;
                border-radius: 8px;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }

        @media (min-width: 1200px) {
            .menu-button {
                font-size: 0.95rem;
                min-height: 70px;
                border-radius: 14px;
            }
            
            .btn {
                font-size: 0.9rem;
            }
        }

        #BookTable th:nth-child(1),
        #BookTable td:nth-child(1) {
            width: 30%;
        }

        #BookTable th:nth-child(2),
        #BookTable td:nth-child(2) {
            width: 20%;
        }

        #BookTable th:nth-child(3),
        #BookTable td:nth-child(3) {
            width: 50%;
        }

        #BookTable canvas {
            max-width: 100%;
            height: 2vh;
        }

        /* Book selector buttons: square with rounded corners, blue + white text */
        .book-switch-btn {
            min-width: 32px;
            min-height: 32px;
            padding: 0;
            border-radius: 0.35rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
        }

        .book-switch-btn i {
            pointer-events: none;
            color: #ffffff;
        }

        .book-scroll {
            display: flex;
            flex-direction: column;
        }

        .book-table-scroll {
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
        }

        .book-header-row {
            display: grid;
            grid-template-columns: 32px minmax(0, 1fr) 32px;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .book-title {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        #book {
            overflow-x: hidden;
        }

        .book-scroll,
        .book-table-scroll {
            overflow-x: hidden;
        }

        body {
            overflow-x: hidden;
        }
    </style>


    <script type="text/javascript" src="/static/js/jquery-3.6.1.min.js"></script>
    <script>
        // Parche global para prevenir errores de Bootstrap
        (function () {
            // Interceptar errores globales
            window.addEventListener('error', function (e) {
                if (e.message && (e.message.includes('split') || e.message.includes('null'))) {
                    e.preventDefault();
                    return false;
                }
            });

            // Parche para split
            const originalSplit = String.prototype.split;
            String.prototype.split = function () {
                if (this == null || this == undefined) return [];
                return originalSplit.apply(this, arguments);
            };

            // Parche para getAttribute
            const originalGetAttribute = Element.prototype.getAttribute;
            Element.prototype.getAttribute = function (name) {
                const value = originalGetAttribute.call(this, name);
                return value === null ? '' : value;
            };
        })();
    </script>
    <script type="text/javascript" src="/static/js/datatables.min.js"></script>
    <script type="text/javascript" src="/static/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="/static/js/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="/static/js/bootstrap-5.5.2.min.js"></script>
    <script type="text/javascript" src="/static/js/chess960.min.js"></script>
    <script type="text/javascript" src="/static/js/chessground.min.js"></script>
</head>

<body>
    {% try %}
    {% if theme=='dark' or theme=='light' %}
    <script type="text/javascript" src="/static/js/mdb.min.js"></script>
    {% end %}
    {% except %}
    <script type="text/javascript" src="/static/js/mdb.min.js"></script>
    {% end %}
    <div class="scroll-portrait">
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <div id="board_panel" class="panel panel-primary">
                            <div class="card-body" style="position:relative;">
                                <div id="evaluationBar" class="evaluation-bar-horizontal" style="visibility: hidden;">
                                    <div class="evaluation-container-horizontal">
                                        <div class="evaluation-fill-horizontal" id="evaluationFill"></div>
                                        <div class="evaluation-center-line-horizontal"></div>
                                        <div class="evaluation-value-horizontal" id="evaluationValue">0.0</div>
                                    </div>
                                </div>
                                <section id="xboardsection" class="natural-wood merida svg-container">
                                    <div class="board-container">
                                        <div id="board" class="svg-content" style="margin-bottom: 10px;"></div>
                                    </div>
                                </section>
                                <div class="container-fluid" id="boardcontrol" style="height:79px; border-bottom-width:20px;
                                                                margin-bottom: 0px;">
                                    <div class="row" id="boardButtons">
                                        <div class="text-center">
                                            <div class="btn-group btn-group-sm d-flex" role="group">
                                                <button type="button" id="flipOrientationBtn" class="btn btn-light">
                                                    <i class="fa fa-refresh"></i></button>
                                                <button type="button" id="DgtSyncBtn" class="btn btn-light">
                                                    <i class="fa fa-delicious"></i></button>
                                                <button type="button" id="colorBtn" class="btn btn-light"
                                                    style="font-size: 0.7em;">
                                                    color</button>
                                                <button type="button" id="startBtn" class="btn btn-light">
                                                    <i class='fa fa-fast-backward'></i></button>
                                                <button type="button" id="backBtn" class="btn btn-light">
                                                    <i class='fa fa-arrow-left'></i></button>
                                                <button type="button" id="fwdBtn" class="btn btn-light">
                                                    <i class='fa fa-arrow-right'></i></button>
                                                <button type="button" id="endBtn" class="btn btn-light">
                                                    <i class='fa fa-fast-forward'></i></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <div class="pull-left">
                                                <div class="boardinfo">
                                                    <span id="sidetomove"></span>&nbsp;<span id="BoardStatus"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="boardControlButtons" class="col">
                                            <div class="d-flex justify-content-end flex-wrap gap-2">
                                                <!-- Download button -->
                                                <button type="button" id="downloadBtn" class="btn btn-info btn-sm">
                                                    <i class="fa fa-download"></i>
                                                    <span class="btn-text"> Get PGN</span>
                                                </button>

                                                <!-- Upload button (now consistent as a real button) -->
                                                <button type="button" id="uploadBtn" class="btn btn-info btn-sm">
                                                    <i class="fa fa-upload"></i>
                                                    <span class="btn-text"> Upload</span>
                                                </button>
                                                <!-- Mute button -->
                                                <button id="btn-mute" class="btn-action" onclick="toggleMute()"
                                                    title="Silenciar">
                                                    <span>ðŸ”Š</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <div class="col">
                    <div class="container">
                        <div class="row">
                            <div class="card">
                                <div class="card-header"
                                    style="font-size: 2.5vh; display: flex; justify-content: center; align-items: center;">
                                    <span>PicoChess Version 4.1.9</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <form id="moveForm" autocomplete="off" style="margin: 0;">
                                            <input id="moveInput" type="text" inputmode="none" value="" style="
                                                position:absolute;
                                                left:0; top:0;
                                                opacity:0;
                                                caret-color:transparent;
                                                border:none;
                                                outline:none;
                                                width:1px; height:1px;" maxlength="5" autocomplete="off"
                                                autocorrect="off" autocapitalize="off" spellcheck="false" title="Move"
                                                data-bs-toggle="" />
                                        </form>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="pull-left">
                                        <div id="DGTClockText"></div>
                                    </div>
                                    <div class="pull-right">
                                        <div id="DGTClockStatus"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div id="clockbuttons" class="text-center">
                                <div class="btn-group btn-group-lg d-flex" role="group">
                                    <button type="button" id="ClockLeverBtn" class="btn btn-danger"
                                        data-placement="auto">
                                        <i id="leverUp" class='fa fa-long-arrow-up fa-lg'></i><i id="leverDown"
                                            class='fa fa-long-arrow-down fa-lg' style="display: none;"></i>
                                    </button>
                                    <button type="button" id="ClockBtn0" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-backward fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn1" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-minus fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn2" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-pause fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn3" class="btn btn-light" data-placement="auto">
                                        <i class='fa fa-plus fa-lg'></i>
                                    </button>
                                    <button type="button" id="ClockBtn4" class="btn btn-warning" data-placement="auto">
                                        <i class='fa fa-forward fa-lg'></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="card">
                                <div class="scroll_movelist" id="moveList">
                                    <div class="card-body">
                                        <div id="pgn"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div id="data" class="card">
                                <div class="card-header">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <ul class="nav nav-pills mb-0" id="pills-tab" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="pills-menu-tab" data-bs-toggle="pill"
                                                    data-bs-target="#menu" type="button" role="tab">Menu
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="pills-home-tab" data-bs-toggle="pill"
                                                    data-bs-target="#engine" type="button" role="tab">Engine
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="pills-tutor-tab" data-bs-toggle="pill"
                                                    data-bs-target="#tutor" type="button" role="tab">Tutor
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="pills-profile-tab"
                                                    data-bs-toggle="pill" data-bs-target="#book" type="button"
                                                    role="tab">Book
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill"
                                                    data-bs-target="#games" type="button" role="tab">Games
                                                </button>
                                            </li>

                                        </ul>
                                        <span id="engine-version-text"
                                            style="display: none; font-weight: bold; color: #666;">Stockfish 17.1</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="pills-tabContent">
                                        <div class="tab-pane fade show active" id="menu" role="tabpanel">
                                            <div id="menuButtons" style="padding: 5px;">
                                                <div class="row g-1">
                                                    <div class="col-4">
                                                        <button type="button" id="newGameBtn" class="btn menu-button">
                                                            <i class="fa fa-plus"></i>
                                                            <span>New Game</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="button" id="tutorWatchBtn" class="btn menu-button">
                                                            <i class="fa fa-eye-slash"></i>
                                                            <span>Tutor</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="button" id="scanBtn" class="btn menu-button">
                                                            <i class="fa fa-delicious"></i>
                                                            <span>Scan</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="button" id="resignBtn" class="btn menu-button">
                                                            <i class="fa fa-flag"></i>
                                                            <span>Resign</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="button" id="replayBtn" class="btn menu-button">
                                                            <i class="fa fa-play"></i>
                                                            <span>Open Last Game</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-4">
                                                        <button type="button" id="saveGameBtn" class="btn menu-button">
                                                            <i class="fa fa-save"></i>
                                                            <span>Save Game</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="scanContainer" class="scroll_obooklist" style="display: none;">
                                                <div class="d-flex justify-content-between align-items-center mb-3" style="padding: 0 15px;">
                                                    <button type="button" id="scanActiveBtn" class="btn btn-danger" style="width: 70%; height: 40px;">
                                                        <i class="fa fa-delicious"></i>
                                                        <span>Sync Board</span>
                                                    </button>
                                                    <button type="button" id="backToMenuBtn" class="btn btn-secondary" style="width: 25%; height: 40px;">
                                                        <i class="fa fa-arrow-left"></i>
                                                    </button>
                                                </div>
                                                <div class="scan-controls" style="padding: 15px;">
                                                    <div class="row mb-3 align-items-center">
                                                        <div class="col-4">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="sideToPlaySwitch">
                                                                </div>
                                                                <div id="pawnPreview"
                                                                    style="display: flex; align-items: center; gap: 3px;">
                                                                    <div id="pawnPiece"
                                                                        style="width: 30px; height: 30px; background-color: white; border: 0.5px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: black;">
                                                                        â™™</div>
                                                                    <div style="font-size: 20px; font-weight: bold;">â†‘
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="d-flex align-items-center gap-2"
                                                                style="justify-content: center;">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="boardSideSwitch">
                                                                </div>
                                                                <div id="boardPreview"
                                                                    style="display: flex; flex-direction: column; align-items: center;">
                                                                    <div
                                                                        style="display: flex; flex-direction: column; width: 30px; height: 30px; border: 2px solid #333;">
                                                                        <div
                                                                            style="display: flex; width: 100%; height: 50%;">
                                                                            <div id="topLeftSquare"
                                                                                style="width: 50%; height: 100%; background-color: white; border: 1px solid #666;">
                                                                            </div>
                                                                            <div id="topRightSquare"
                                                                                style="width: 50%; height: 100%; background-color: black; border: 1px solid #666;">
                                                                            </div>
                                                                        </div>
                                                                        <div
                                                                            style="display: flex; width: 100%; height: 50%;">
                                                                            <div id="bottomLeftSquare"
                                                                                style="width: 50%; height: 100%; background-color: black; border: 1px solid #666;">
                                                                            </div>
                                                                            <div id="bottomRightSquare"
                                                                                style="width: 50%; height: 100%; background-color: white; border: 1px solid #666;">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div id="sideIndicator"
                                                                        style="width: 20px; height: 6px; background-color: white; margin-top: 3px; border: 0.5px solid #333;">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-4">
                                                            <div class="d-flex align-items-center gap-2"
                                                                style="justify-content: flex-end;">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="uci960Switch">
                                                                </div>
                                                                <label class="form-check-label" for="uci960Switch"
                                                                    id="uci960Label"
                                                                    style="font-size: 14px; font-weight: bold;">
                                                                    UCI960 No
                                                                </label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row mb-3">
                                                        <div class="col-6">
                                                            <div
                                                                style="display: flex; flex-direction: column; gap: 10px;">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="whiteCastleKingSwitch" checked>
                                                                    <label class="form-check-label"
                                                                        for="whiteCastleKingSwitch">
                                                                        <span
                                                                            style="color: white; text-shadow: 1px 1px 0 black, -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black;">&#9632;</span>
                                                                        O-O
                                                                    </label>
                                                                </div>
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="whiteCastleQueenSwitch" checked>
                                                                    <label class="form-check-label"
                                                                        for="whiteCastleQueenSwitch">
                                                                        <span
                                                                            style="color: white; text-shadow: 1px 1px 0 black, -1px -1px 0 black, 1px -1px 0 black, -1px 1px 0 black;">&#9632;</span>
                                                                        O-O-O
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">
                                                            <div
                                                                style="display: flex; flex-direction: column; gap: 10px;">
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="blackCastleKingSwitch" checked>
                                                                    <label class="form-check-label"
                                                                        for="blackCastleKingSwitch">
                                                                        <span
                                                                            style="color: black; text-shadow: 1px 1px 0 white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;">&#9632;</span>
                                                                        O-O
                                                                    </label>
                                                                </div>
                                                                <div class="form-check form-switch">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        id="blackCastleQueenSwitch" checked>
                                                                    <label class="form-check-label"
                                                                        for="blackCastleQueenSwitch">
                                                                        <span
                                                                            style="color: black; text-shadow: 1px 1px 0 white, -1px -1px 0 white, 1px -1px 0 white, -1px 1px 0 white;">&#9632;</span>
                                                                        O-O-O
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="engine" role="tabpanel">
                                            <div class="scroll_engine">
                                                <div class="row">
                                                    <div class="col-4">
                                                        <span id="engineMultiPVStatus" class="btn-group"></span>
                                                    </div>
                                                    <div class="col-8">
                                                        <div class="btn-group btn-group-xs pull-right" role="group">
                                                            <button id="analyzeBtn" class="btn btn-success"
                                                                data-placement="auto">
                                                                <i class='fa fa-cog'></i>
                                                                <span id="AnalyzeText">Analyze</span>
                                                            </button>
                                                        </div>
                                                        <div class="btn-group btn-group-xs pull-right" role="group">
                                                            <button id="analyzeMinus" class="btn btn-light"
                                                                data-placement="auto">
                                                                <span id="analyzeMinusText">
                                                                    <i class='fa fa-minus'></i>
                                                                </span>
                                                            </button>
                                                            <button id="analyzePlus" class="btn btn-light"
                                                                data-placement="auto">
                                                                <span id="analyzePlusText"><i
                                                                        class='fa fa-plus'></i></span>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <div id="listener">
                                                        <embed name="nacl_module" id='stockfish_module' width="0"
                                                            height="0" src='/static/stockfish/stockfish.nmf'
                                                            type='application/x-pnacl' />
                                                    </div>
                                                    <div id="engineStatus"></div>
                                                </div>
                                                <div class="row">
                                                    <div id="pv_output" class="gameMoves list-group">
                                                        <div id="pv_1" class="pv-container">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="tutor" role="tabpanel">
                                            <div class="scroll_obooklist" style="padding: 10px;">
                                                <ul id="tutorMistakeList" class="list-group list-group-flush"></ul>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="book" role="tabpanel"
                                              style="padding-left: 10px;">
                                            <div class="scroll_obooklist book-scroll">
                                                <div id="currentBookContainer" class="mb-2 d-none">
                                                    <div class="alert alert-secondary py-1 px-2 text-center mb-2">
                                                        <div class="book-header-row">
                                                            <button type="button" id="bookPrev" class="btn btn-sm btn-primary book-switch-btn">
                                                                <i class="fa fa-chevron-left"></i>
                                                            </button>
                                                            <span class="book-title">
                                                                <span class="fw-bold">Book:&nbsp;</span>
                                                                <span id="currentBookName">No book</span>
                                                            </span>
                                                            <button type="button" id="bookNext" class="btn btn-sm btn-primary book-switch-btn">
                                                                <i class="fa fa-chevron-right"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="book-table-scroll">
                                                    <table id="BookTable" class="table compact table-bordered row-border"
                                                          style="font-size: 1.6vw; text-align: center; width: 100%;">
                                                          <thead>
                                                              <tr>
                                                                  <th data-priority="1">Move</th>
                                                                  <th data-priority="2">Games</th>
                                                                  <th>Results</th>
                                                              </tr>
                                                          </thead>
                                                      </table>
                                                </div>
                                              </div>
                                          </div>
                                        <div class="tab-pane fade" id="games" role="tabpanel">
                                            <table id="GameTable"
                                                class="table table-hover compact table-bordered row-border"
                                                style="font-size: 1.3vw; width: 100%;">
                                                <thead>
                                                    <tr>
                                                        <th data-priority="1">White</th>
                                                        <th data-priority="2">Black</th>
                                                        <th data-priority="3">Result</th>
                                                        <th data-priority="4">Event</th>
                                                    </tr>
                                                </thead>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            window.picoWebConfig = window.picoWebConfig || {};
            window.picoWebConfig.webSpeech = {{ "true" if web_speech else "false" }};
        </script>
        <script type="text/javascript" src="/static/js/app.js?v=2"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Script del input de movimientos
                const moveInput = document.getElementById('moveInput');
                if (moveInput) {
                    moveInput.focus();
                    moveInput.addEventListener('keydown', async function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const move = (this.value || '').toString();
                            if (move && move.length > 0) {
                                await fetch('/channel', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: 'action=command&command=' + encodeURIComponent(move)
                                });
                                this.value = "";
                            }
                        }
                    });
                    // Mantener el foco siempre en el input de jugada
                    document.addEventListener('click', function (e) {
                        if (e.target !== moveInput && moveInput) {
                            setTimeout(() => moveInput.focus(), 10);
                        }
                    });
                }

                // New Game button event handler
                const newGameBtn = document.getElementById('newGameBtn');
                if (newGameBtn) {
                    newGameBtn.addEventListener('click', async function () {
                        if (confirm('New Game ??')) {
                            try {
                                await fetch('/channel', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: 'action=new_game'
                                });
                            } catch (error) {
                                console.error('Error starting new game:', error);
                            }
                        }
                    });
                }

                // Tutor+Watch combined button event handler
                const tutorWatchBtn = document.getElementById('tutorWatchBtn');
                if (tutorWatchBtn) {
                    let tutorWatchActive = false;
                    const tutorWatchSpan = tutorWatchBtn.querySelector('span');
                    const tutorWatchIcon = tutorWatchBtn.querySelector('i');
                    
                    tutorWatchBtn.addEventListener('click', async function () {
                        try {
                            // Actualizar visualizaciÃ³n
                            if (tutorWatchActive) {
                                // Desactivar ambos
                                this.classList.remove('active');
                                tutorWatchSpan.innerHTML = 'Tutor';
                                tutorWatchIcon.className = 'fa fa-eye-slash';
                            } else {
                                // Activar ambos
                                this.classList.add('active');
                                tutorWatchSpan.innerHTML = 'Tutor';
                                tutorWatchIcon.className = 'fa fa-eye';
                            }
                            
                            // Enviar acciÃ³n combinada al servidor
                            await fetch('/channel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: `action=tutor_watch&active=${!tutorWatchActive}`
                            });
                            
                            tutorWatchActive = !tutorWatchActive;
                        } catch (error) {
                            console.error('Error toggling tutor+watch:', error);
                        }
                    });
                }

                // Resign button event handler
                const resignBtn = document.getElementById('resignBtn');
                if (resignBtn) {
                    resignBtn.addEventListener('click', async function () {
                        if (confirm('Resign Game ??')) {
                            try {
                                await fetch('/channel', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                    body: 'action=resign_game'
                                });
                            } catch (error) {
                                console.error('Error resigning game:', error);
                            }
                        }
                    });
                }

                // Replay button event handler
                const replayBtn = document.getElementById('replayBtn');
                if (replayBtn) {
                    replayBtn.addEventListener('click', async function () {
                        try {
                            await fetch('/channel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: 'action=pgn_replay'
                            });
                        } catch (error) {
                            console.error('Error starting PGN replay:', error);
                        }
                    });
                }

                // Save Game button event handler
                const saveGameBtn = document.getElementById('saveGameBtn');
                if (saveGameBtn) {
                    saveGameBtn.addEventListener('click', async function () {
                        try {
                            await fetch('/channel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: 'action=save_game&slot=1'
                            });
                        } catch (error) {
                            console.error('Error saving game:', error);
                        }
                    });
                }

                // Scan button event handler
                const scanBtn = document.getElementById('scanBtn');
                const backToMenuBtn = document.getElementById('backToMenuBtn');
                const scanActiveBtn = document.getElementById('scanActiveBtn');
                const menuButtons = document.getElementById('menuButtons');
                const scanContainer = document.getElementById('scanContainer');
                
                if (scanBtn && menuButtons && scanContainer) {
                    scanBtn.addEventListener('click', function () {
                        menuButtons.style.display = 'none';
                        scanContainer.style.display = 'block';
                    });
                }
                
                if (backToMenuBtn && menuButtons && scanContainer) {
                    backToMenuBtn.addEventListener('click', function () {
                        scanContainer.style.display = 'none';
                        menuButtons.style.display = 'block';
                    });
                }
                
                // Scan active button functionality
                if (scanActiveBtn) {
                    scanActiveBtn.addEventListener('click', async function () {
                        const sideToPlaySwitch = document.getElementById('sideToPlaySwitch');
                        const boardSideSwitch = document.getElementById('boardSideSwitch');
                        const uci960Switch = document.getElementById('uci960Switch');
                        
                        const sideToPlay = sideToPlaySwitch.checked ? 'false' : 'true';
                        const boardSide = boardSideSwitch.checked ? 'true' : 'false';
                        const whiteCastleKing = document.getElementById('whiteCastleKingSwitch').checked;
                        const whiteCastleQueen = document.getElementById('whiteCastleQueenSwitch').checked;
                        const blackCastleKing = document.getElementById('blackCastleKingSwitch').checked;
                        const blackCastleQueen = document.getElementById('blackCastleQueenSwitch').checked;
                        const uci960 = uci960Switch.checked ? 'true' : 'false';

                        try {
                            const currentFen = window.chessground1 ? window.chessground1.getFen() : 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR';

                            const response = await fetch('/channel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({
                                    action: 'scan_board',
                                    currentFen: currentFen,
                                    sideToPlay: sideToPlay,
                                    boardSide: boardSide,
                                    whiteCastleKing: whiteCastleKing,
                                    whiteCastleQueen: whiteCastleQueen,
                                    blackCastleKing: blackCastleKing,
                                    blackCastleQueen: blackCastleQueen,
                                    uci960: uci960
                                })
                            });

                            if (response.ok) {
                                const result = await response.json();
                                if (result.success && result.fen) {
                                    console.log('Escaneo completado. FEN:', result.fen);
                                } else {
                                    console.error('Error: PosiciÃ³n invÃ¡lida');
                                }
                            } else {
                                console.error('Error en el escaneo del tablero');
                            }
                        } catch (error) {
                            console.error('Error de conexiÃ³n:', error);
                        }
                    });
                }
            });
        </script>


        <!-- JavaScript for consistent tab rendering and board display -->
        <script>
            // Force consistent board rendering regardless of active tab
            document.addEventListener('DOMContentLoaded', function () {
                // Get all tab buttons
                const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
                const engineVersionText = document.getElementById('engine-version-text');

                // Function to update engine version text visibility
                function updateEngineVersionVisibility() {
                    const engineTab = document.getElementById('pills-home-tab');
                    if (engineTab && engineVersionText) {
                        engineVersionText.style.display = 'none';
                    }
                }

                // Add click event listeners to all tab buttons
                tabButtons.forEach(function (button) {
                    button.addEventListener('click', function () {
                        // Get the board element
                        const board = document.getElementById('board');

                        // Force reflow of the board element
                        if (board) {
                            // Small delay to allow tab switching to complete
                            setTimeout(function () {
                                // These operations force a reflow/repaint
                                const display = board.style.display;
                                board.style.display = 'none';
                                void board.offsetHeight; // Trigger reflow
                                board.style.display = display;

                                // Additional resize event to reposition chessground
                                const evt = new Event('resize');
                                window.dispatchEvent(evt);

                                // Update engine version text visibility
                                updateEngineVersionVisibility();
                            }, 50);
                        }
                    });
                });

                // Initial check for engine version text visibility
                updateEngineVersionVisibility();

                // Listen for Bootstrap tab events
                document.addEventListener('shown.bs.tab', function (e) {
                    updateEngineVersionVisibility();
                });

                // Ajustar el ancho de la barra de evaluaciÃ³n al ancho del tablero
                function adjustEvaluationBarWidth() {
                    var boardElement = document.getElementById('board');
                    var evaluationContainer = document.querySelector('.evaluation-container-horizontal');
                    if (boardElement && evaluationContainer) {
                        var boardWidth = boardElement.offsetWidth;
                        evaluationContainer.style.width = boardWidth + 'px';
                    }
                }

                setTimeout(adjustEvaluationBarWidth, 500);
                window.addEventListener('resize', adjustEvaluationBarWidth);

                // Forzar redibujado del tablero
                setTimeout(function () {
                    if (window.chessground1) {
                        chessground1.redrawAll();
                    }
                }, 100);
            });

            function toggleMute() {
                var btn = document.getElementById('btn-mute');

                // 1. Cambiamos el aspecto visual (Rojo/Normal)
                btn.classList.toggle('is-muted');
                var isMuted = btn.classList.contains('is-muted');

                // 2. Silenciamos/activamos el cliente web (speechSynthesis)
                if (typeof setSpeechMuted === 'function') {
                    setSpeechMuted(isMuted);
                }
            }
        </script>

        <!-- JavaScript para los controles del tab Scan -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Control del bando que juega
                const sideToPlaySwitch = document.getElementById('sideToPlaySwitch');
                const sideToPlayLabel = document.getElementById('sideToPlayLabel');

                sideToPlaySwitch.addEventListener('change', function () {
                    const pawnPiece = document.getElementById('pawnPiece');
                    if (this.checked) {
                        pawnPiece.style.backgroundColor = 'black';
                        pawnPiece.style.color = 'white';
                        pawnPiece.style.border = '0.5px solid white';
                        pawnPiece.innerHTML = 'â™Ÿ';
                    } else {
                        pawnPiece.style.backgroundColor = 'white';
                        pawnPiece.style.color = 'black';
                        pawnPiece.style.border = '0.5px solid #333';
                        pawnPiece.innerHTML = 'â™™';
                    }
                });

                // Control del lado del tablero
                const boardSideSwitch = document.getElementById('boardSideSwitch');

                boardSideSwitch.addEventListener('change', function () {
                    const sideIndicator = document.getElementById('sideIndicator');
                    if (this.checked) {
                        // Tablero desde perspectiva negras (negras abajo)
                        sideIndicator.style.backgroundColor = 'black';
                        sideIndicator.style.border = '0.5px solid white';
                    } else {
                        // Tablero desde perspectiva blancas (blancas abajo)
                        sideIndicator.style.backgroundColor = 'white';
                        sideIndicator.style.border = '0.5px solid #333';
                    }
                });

                // Control del UCI960
                const uci960Switch = document.getElementById('uci960Switch');
                const uci960Label = document.getElementById('uci960Label');

                uci960Switch.addEventListener('change', function () {
                    if (this.checked) {
                        uci960Label.textContent = 'UCI960';
                    } else {
                        uci960Label.textContent = 'UCI960 No';
                    }
                });


            });
        </script>
</body>

</html>
