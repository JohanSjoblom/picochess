<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Picochess Settings</title>
    <style>
        .tab-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .tab-button {
            border: 1px solid #666;
            background: #f4f4f4;
            padding: 6px 12px;
            cursor: pointer;
        }
        .tab-button.active {
            background: #dfe8ff;
            font-weight: 600;
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        .touch-only {
            display: none;
        }
        .touch-device .touch-only {
            display: inline-block;
        }
        .help-icon {
            margin-left: 6px;
            padding: 0 6px;
            border: 1px solid #666;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 1.2em;
            cursor: pointer;
            user-select: none;
        }
        .help-row td {
            font-size: 0.95em;
            color: #333;
            background: #f4f4f4;
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }
        .help-row {
            font-size: 0.95em;
            color: #333;
            background: #f4f4f4;
            padding: 6px;
        }
        @media (max-width: 600px) {
            table {
                font-size: 0.95em;
            }
            .help-row td {
                font-size: 0.9em;
            }
        }
    </style>
</head>

<body>
    <h1>Picochess Settings</h1>

    <div class="tab-bar">
        <button type="button" class="tab-button active" data-tab="settings">Picochess.ini</button>
        <button type="button" class="tab-button" data-tab="wifi">Wi-Fi</button>
        <button type="button" class="tab-button" data-tab="bluetooth">Bluetooth</button>
    </div>

    <div id="status"></div>

    <div id="settings-panel" class="tab-panel active">
        <p>Changes take effect after the next restart.</p>
        <table border="1" cellpadding="4" cellspacing="0" style="width:100%; table-layout:fixed;">
            <thead>
                <tr>
                    <th>Enabled</th>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="settings-body"></tbody>
        </table>

        <div style="margin-top: 10px;">
            <button type="button" id="addRowBtn">Add setting</button>
            <button type="button" id="saveBtn">Save</button>
            <a href="/">Back</a>
        </div>
    </div>

    <div id="wifi-panel" class="tab-panel">
        <h2>Connect Pi to Wi-Fi</h2>
        <p class="help-row">Enter the phone hotspot or Wi-Fi credentials. The Pi will connect and keep the network for future use.</p>
        <p class="help-row">If you see a permissions error, run <code>sudo ./enable-wifi-setup.sh</code> on the Pi once.</p>
        <p class="help-row">If your phone hotspot credentials are saved in picochess.ini, you can also use the Quick connect button.</p>

        <div style="margin-top: 10px;">
            <button type="button" id="wifi-hotspot-btn">Quick connect</button>
        </div>

        <label for="wifi-ssid">Wi-Fi SSID</label>
        <input type="text" id="wifi-ssid" maxlength="32" autocomplete="off" required>

        <label for="wifi-pass">Password</label>
        <input type="password" id="wifi-pass" autocomplete="new-password">

        <div style="margin-top: 8px;">
            <input type="checkbox" id="wifi-hidden">
            <label for="wifi-hidden">Hidden network</label>
        </div>

        <div style="margin-top: 10px;">
            <button type="button" id="wifi-connect-btn">Connect</button>
        </div>
    </div>

    <div id="bluetooth-panel" class="tab-panel">
        <h2>Bluetooth pairing</h2>
        <p class="help-row">Use these tools to pair a phone or reset Bluetooth if needed.</p>
        <div style="margin-top: 10px;">
            <button type="button" id="bt-pair-btn">Pair phone</button>
            <button type="button" id="bt-fix-btn">Fix Bluetooth</button>
        </div>
    </div>

    <script>
        var isTouchDevice = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
        if (isTouchDevice) {
            document.documentElement.classList.add("touch-device");
        }

        function isBooleanValue(value) {
            return value.trim().toLowerCase() === "true" || value.trim().toLowerCase() === "false";
        }

        function selectOptionsForKey(key) {
            var normalized = (key || "").trim().toLowerCase();
            if (normalized === "log-level") {
                return ["debug", "info", "warning", "error"];
            }
            if (normalized === "tutor-coach") {
                return ["off", "on", "lift"];
            }
            if (normalized === "tutor-comment") {
                return ["single", "all", "off"];
            }
            if (normalized === "board-type") {
                return ["dgt", "certabo", "chesslink", "chessnut", "ichessone", "noeboard"];
            }
            if (normalized === "clockside") {
                return ["left", "right"];
            }
            if (normalized === "language") {
                return ["en", "de", "nl", "fr", "es", "it"];
            }
            if (normalized === "audio-backend") {
                return ["sox", "native"];
            }
            if (normalized === "beep-config") {
                return ["none", "Never", "Sometimes", "Always", "Sample"];
            }
            if (normalized === "theme") {
                return ["", "auto", "light", "dark", "time"];
            }
            return null;
        }

        function setStatus(message, isError) {
            var status = document.getElementById("status");
            status.textContent = message;
            status.style.color = isError ? "red" : "green";
        }

        function triggerAction(action, busyMessage, successMessage) {
            setStatus(busyMessage, false);
            fetch("/settings/action/" + action, { method: "POST" })
                .then(function (response) {
                    if (!response.ok) {
                        return response.json().then(function (data) {
                            throw new Error(data.error || "Action failed");
                        });
                    }
                    return response.json();
                })
                .then(function () {
                    setStatus(successMessage, false);
                })
                .catch(function (error) {
                    setStatus(error.message, true);
                });
        }

        function renderEntry(entry) {
            var row = document.createElement("tr");

            var enabledCell = document.createElement("td");
            var enabledInput = document.createElement("input");
            enabledInput.type = "checkbox";
            enabledInput.checked = Boolean(entry.enabled);
            enabledInput.className = "setting-enabled";
            enabledCell.appendChild(enabledInput);

            var keyCell = document.createElement("td");
            if (entry.editableKey) {
                var keyInput = document.createElement("input");
                keyInput.type = "text";
                keyInput.value = entry.key || "";
                keyInput.size = 20;
                keyInput.className = "setting-key";
                keyCell.appendChild(keyInput);
            } else {
                keyCell.textContent = entry.key;
            }
            if (entry.help) {
                row.title = entry.help;
                keyCell.title = entry.help;
            }
            if (entry.help && isTouchDevice) {
                var helpIcon = document.createElement("span");
                helpIcon.textContent = "?";
                helpIcon.className = "help-icon touch-only";
                helpIcon.title = "Show help";
                helpIcon.addEventListener("click", function () {
                    var next = row.nextSibling;
                    if (next && next.classList && next.classList.contains("help-row")) {
                        next.parentNode.removeChild(next);
                        return;
                    }
                    var helpRow = document.createElement("tr");
                    helpRow.className = "help-row";
                    var helpCell = document.createElement("td");
                    helpCell.colSpan = 3;
                    helpCell.textContent = entry.help;
                    helpRow.appendChild(helpCell);
                    row.parentNode.insertBefore(helpRow, row.nextSibling);
                });
                keyCell.appendChild(helpIcon);
            }

            var valueCell = document.createElement("td");
            var valueInput;
            var options = selectOptionsForKey(entry.key);
            if (options) {
                valueInput = document.createElement("select");
                options.forEach(function (optionValue) {
                    var option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    valueInput.appendChild(option);
                });
                valueInput.value = (entry.value || "").trim().toLowerCase();
            } else if (isBooleanValue(entry.value)) {
                valueInput = document.createElement("select");
                ["true", "false"].forEach(function (optionValue) {
                    var option = document.createElement("option");
                    option.value = optionValue;
                    option.textContent = optionValue;
                    valueInput.appendChild(option);
                });
                valueInput.value = entry.value.trim().toLowerCase();
            } else {
                valueInput = document.createElement("input");
                valueInput.type = "text";
                valueInput.value = entry.value || "";
                valueInput.size = 40;
            }
            valueInput.className = "setting-value";
            valueCell.appendChild(valueInput);

            row.appendChild(enabledCell);
            row.appendChild(keyCell);
            row.appendChild(valueCell);
            row.dataset.key = entry.key;
            if (entry.editableKey) {
                row.dataset.editableKey = "1";
            }

            return row;
        }

        function collectEntries() {
            var rows = document.querySelectorAll("#settings-body tr");
            var entries = [];
            rows.forEach(function (row) {
                var keyInput = row.querySelector(".setting-key");
                var key = keyInput ? keyInput.value.trim() : row.dataset.key;
                var enabled = row.querySelector(".setting-enabled").checked;
                var valueInput = row.querySelector(".setting-value");
                if (!key) {
                    return;
                }
                entries.push({
                    key: key,
                    value: valueInput.value,
                    enabled: enabled
                });
            });
            return entries;
        }

        function addEmptyRow() {
            var body = document.getElementById("settings-body");
            var entry = { key: "", value: "", enabled: true, editableKey: true, help: "" };
            var row = renderEntry(entry);
            body.appendChild(row);
        }

        function loadSettings() {
            fetch("/settings/data")
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Failed to load settings");
                    }
                    return response.json();
                })
                .then(function (data) {
                    var body = document.getElementById("settings-body");
                    body.innerHTML = "";
                    (data.entries || []).forEach(function (entry) {
                        body.appendChild(renderEntry(entry));
                    });
                    if (!data.entries || data.entries.length === 0) {
                        setStatus("No settings found in picochess.ini", true);
                    } else {
                        setStatus("", false);
                    }
                })
                .catch(function (error) {
                    setStatus(error.message, true);
                });
        }

        document.getElementById("saveBtn").addEventListener("click", function () {
            var entries = collectEntries();
            fetch("/settings/save", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ entries: entries })
            })
                .then(function (response) {
                    if (!response.ok) {
                        throw new Error("Failed to save settings");
                    }
                    return response.json();
                })
                .then(function () {
                    setStatus("Settings saved.", false);
                })
                .catch(function (error) {
                    setStatus(error.message, true);
                });
        });

        document.getElementById("addRowBtn").addEventListener("click", function () {
            addEmptyRow();
        });

        document.querySelectorAll(".tab-button").forEach(function (btn) {
            btn.addEventListener("click", function () {
                document.querySelectorAll(".tab-button").forEach(function (b) { b.classList.remove("active"); });
                document.querySelectorAll(".tab-panel").forEach(function (p) { p.classList.remove("active"); });
                btn.classList.add("active");
                var tab = btn.getAttribute("data-tab");
                if (tab === "wifi") {
                    document.getElementById("wifi-panel").classList.add("active");
                } else if (tab === "bluetooth") {
                    document.getElementById("bluetooth-panel").classList.add("active");
                } else {
                    document.getElementById("settings-panel").classList.add("active");
                }
            });
        });

        document.getElementById("wifi-connect-btn").addEventListener("click", function () {
            var ssid = document.getElementById("wifi-ssid").value.trim();
            var password = document.getElementById("wifi-pass").value;
            var hidden = document.getElementById("wifi-hidden").checked;

            if (!ssid) {
                setStatus("SSID is required", true);
                return;
            }
            if (password && password.length < 8) {
                setStatus("Password must be at least 8 characters", true);
                return;
            }

            setStatus("Connecting...", false);
            fetch("/onboard/wifi", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ssid: ssid, password: password, hidden: hidden })
            })
                .then(function (response) {
                    if (!response.ok) {
                        return response.json().then(function (data) {
                            throw new Error(data.error || "Wi-Fi connect failed");
                        });
                    }
                    return response.json();
                })
                .then(function (data) {
                    if (data.ip) {
                        setStatus("Connected. Pi IP: " + data.ip, false);
                    } else {
                        setStatus("Connected.", false);
                    }
                })
                .catch(function (error) {
                    setStatus(error.message, true);
                });
        });

        document.getElementById("wifi-hotspot-btn").addEventListener("click", function () {
            triggerAction("wifi-hotspot", "Connecting hotspot...", "Hotspot connect started.");
        });

        document.getElementById("bt-pair-btn").addEventListener("click", function () {
            triggerAction("bt-pair", "Starting Bluetooth pairing...", "Bluetooth pairing started.");
        });

        document.getElementById("bt-fix-btn").addEventListener("click", function () {
            triggerAction("bt-fix", "Running Bluetooth fix...", "Bluetooth fix started.");
        });

        loadSettings();
    </script>
</body>

</html>
