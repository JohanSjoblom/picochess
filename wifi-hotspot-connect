#!/usr/bin/env python3
import os
import subprocess
import sys

INI_PATH = "/opt/picochess/picochess.ini"
NMCLI = "/usr/bin/nmcli"


def read_hotspot(path: str) -> tuple[str | None, str | None]:
    ssid = None
    password = None
    try:
        with open(path, "r", encoding="utf-8") as handle:
            for raw in handle:
                line = raw.strip()
                if not line or line.startswith("#") or "=" not in line:
                    continue
                key, value = [part.strip() for part in line.split("=", 1)]
                if key == "hotspot-ssid" and value:
                    ssid = value
                if key == "hotspot-pass" and value:
                    password = value
    except OSError:
        return None, None
    return ssid, password


def run(cmd, timeout=20):
    return subprocess.run(cmd, capture_output=True, text=True, timeout=timeout)


def main() -> int:
    if not os.path.exists(NMCLI):
        print("wifi-hotspot-connect: nmcli not found", file=sys.stderr)
        return 2
    ssid, password = read_hotspot(INI_PATH)
    if not ssid:
        print("wifi-hotspot-connect: hotspot-ssid not set", file=sys.stderr)
        return 2

    cmd = [NMCLI, "dev", "wifi", "connect", ssid]
    if password:
        cmd += ["password", password]
    if os.geteuid() != 0:
        cmd = ["sudo", "-n"] + cmd
    try:
        result = run(cmd, timeout=20)
    except subprocess.TimeoutExpired:
        print("wifi-hotspot-connect: connect timed out", file=sys.stderr)
        return 3
    if result.returncode != 0:
        msg = (result.stderr or result.stdout or "connect failed").strip()
        print(f"wifi-hotspot-connect: {msg}", file=sys.stderr)
        return 1

    ip_cmd = [NMCLI, "-g", "IP4.ADDRESS", "dev", "show", "wlan0"]
    if os.geteuid() != 0:
        ip_cmd = ["sudo", "-n"] + ip_cmd
    try:
        ip_result = run(ip_cmd, timeout=10)
    except subprocess.TimeoutExpired:
        ip_result = subprocess.CompletedProcess([], 124, stdout="", stderr="timeout")
    ip_addr = ""
    if ip_result.returncode == 0:
        ip_addr = ip_result.stdout.strip().split("\n")[0].split("/")[0]
    if ip_addr:
        print(f"wifi-hotspot-connect: connected {ip_addr}")
    else:
        print("wifi-hotspot-connect: connected")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
